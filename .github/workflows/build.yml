name: Build and Release Windows Publish

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'

    - name: Install dependencies
      run: npm install

    - name: Update version
      id: version
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Read package.json
          const packageJsonPath = path.join(process.cwd(), 'package.json');
          const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
          
          // Get current version
          const currentVersion = packageJson.version;
          console.log(`Current version: ${currentVersion}`);
          
          // Split version into parts
          const versionParts = currentVersion.split('.');
          const major = parseInt(versionParts[0]);
          const minor = parseInt(versionParts[1]);
          const patch = parseInt(versionParts[2]);
          
          // Increment patch version
          const newPatch = patch + 1;
          const newVersion = `${major}.${minor}.${newPatch}`;
          console.log(`New version: ${newVersion}`);
          
          // Update package.json
          packageJson.version = newVersion;
          fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2));
          
          // Output new version for later steps
          return newVersion;

    - name: Build for Windows
      run: npm run dist
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.result }}
        name: Release v${{ steps.version.outputs.result }}
        draft: false
        prerelease: false
        files: |
          release/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}