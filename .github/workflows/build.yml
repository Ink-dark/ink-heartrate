name: Build and Release Windows Publish

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'

    - name: Install dependencies
      run: |
        npm install -g cnpm --registry=https://registry.npmmirror.com
        cnpm install

    - name: Extract version from tag
      id: version
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Get current ref
          const ref = process.env.GITHUB_REF;
          console.log(`Current ref: ${ref}`);
          
          // Check if it's a tag
          if (ref && ref.startsWith('refs/tags/v')) {
            // Extract version from tag
            const tagVersion = ref.replace('refs/tags/v', '');
            console.log(`Version from tag: ${tagVersion}`);
            
            // Update package.json
            const packageJsonPath = path.join(process.cwd(), 'package.json');
            const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
            packageJson.version = tagVersion;
            fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2));
            
            // Output version
            core.setOutput('new_version', tagVersion);
          } else {
            // Fallback to incrementing patch version (for non-tag pushes)
            const packageJsonPath = path.join(process.cwd(), 'package.json');
            const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
            
            const currentVersion = packageJson.version;
            console.log(`Current version: ${currentVersion}`);
            
            const versionParts = currentVersion.split('.');
            const major = parseInt(versionParts[0]);
            const minor = parseInt(versionParts[1]);
            const patch = parseInt(versionParts[2]);
            
            const newPatch = patch + 1;
            const newVersion = `${major}.${minor}.${newPatch}`;
            console.log(`New version: ${newVersion}`);
            
            packageJson.version = newVersion;
            fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2));
            
            core.setOutput('new_version', newVersion);
          }

    - name: Build for Windows
      run: npm run dist
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.new_version }}
        name: Release v${{ steps.version.outputs.new_version }}
        draft: false
        prerelease: false
        files: |
          release/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}